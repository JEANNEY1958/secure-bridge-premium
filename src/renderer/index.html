<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
  <title>Secure Bridge Premium</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #e0e0e0;
      min-height: 100vh;
      overflow: hidden;
    }
    .titlebar {
      -webkit-app-region: drag;
      height: 32px;
      background: rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      padding: 0 16px;
    }
    .titlebar h1 {
      font-size: 13px;
      font-weight: 500;
      opacity: 0.8;
    }
    .container {
      padding: 24px;
      max-width: 600px;
      margin: 0 auto;
    }
    .card {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 16px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .card h2 {
      font-size: 18px;
      margin-bottom: 16px;
      color: #4da6ff;
    }
    .form-group {
      margin-bottom: 16px;
    }
    label {
      display: block;
      font-size: 13px;
      color: #888;
      margin-bottom: 6px;
    }
    input, select {
      width: 100%;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(0,0,0,0.3);
      color: #fff;
      font-size: 14px;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #4da6ff;
    }
    button {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: linear-gradient(135deg, #4da6ff 0%, #3d8bd8 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(77,166,255,0.3);
    }
    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }
    .btn-danger {
      background: #e74c3c;
      color: white;
    }
    .status-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #888;
    }
    .status-dot.connected {
      background: #2ecc71;
      box-shadow: 0 0 8px #2ecc71;
    }
    .status-dot.connecting {
      background: #f1c40f;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .log-container {
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 16px;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
    }
    .log-entry {
      padding: 4px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .log-entry.success { color: #2ecc71; }
    .log-entry.error { color: #e74c3c; }
    .log-entry.info { color: #4da6ff; }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
      cursor: pointer;
      transition: all 0.2s;
    }
    .tab.active {
      background: #4da6ff;
      color: white;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .button-row {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="titlebar">
    <h1>Secure Bridge Premium</h1>
  </div>

  <div class="container">
    <div class="status-bar">
      <div class="status-dot" id="statusDot"></div>
      <div id="statusText">Disconnected</div>
      <div style="flex: 1"></div>
      <div id="lastHeartbeat" style="font-size: 12px; color: #666;"></div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="connection">Connection</div>
      <div class="tab" data-tab="credentials">API Keys</div>
      <div class="tab" data-tab="logs">Trade Logs</div>
    </div>

    <div class="tab-content active" id="connection">
      <div class="card">
        <h2>Server Connection</h2>
        <div class="form-group">
          <label>Server URL</label>
          <input type="text" id="serverUrl" placeholder="https://kirk.replit.dev">
        </div>
        <div class="form-group">
          <label>Auth Secret</label>
          <input type="password" id="authSecret" placeholder="BRIDGE_AUTH_SECRET">
        </div>
        <div class="form-group">
          <label>Trading Mode</label>
          <select id="tradingMode">
            <option value="paper">Paper Trading</option>
            <option value="live">Live Trading</option>
          </select>
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="autoConnect" checked> Auto-reconnect
          </label>
        </div>
        <div class="button-row">
          <button class="btn-primary" id="connectBtn">Connect</button>
          <button class="btn-secondary" id="saveConfigBtn">Save Config</button>
        </div>
      </div>
    </div>

    <div class="tab-content" id="credentials">
      <div class="card">
        <h2>Paper Trading Keys</h2>
        <div class="form-group">
          <label>API Key ID</label>
          <input type="text" id="paperApiKey" placeholder="PK...">
        </div>
        <div class="form-group">
          <label>Secret Key</label>
          <input type="password" id="paperSecretKey" placeholder="*************">
        </div>
      </div>
      <div class="card">
        <h2>Live Trading Keys</h2>
        <div class="form-group">
          <label>API Key ID</label>
          <input type="text" id="liveApiKey" placeholder="AK...">
        </div>
        <div class="form-group">
          <label>Secret Key</label>
          <input type="password" id="liveSecretKey" placeholder="*************">
        </div>
      </div>
      <div class="button-row">
        <button class="btn-primary" id="saveCredsBtn">Save Credentials</button>
        <button class="btn-secondary" id="testAlpacaBtn">Test Connection</button>
      </div>
    </div>

    <div class="tab-content" id="logs">
      <div class="card">
        <h2>Trade Activity</h2>
        <div class="log-container" id="logContainer">
          <div class="log-entry info">Waiting for trade signals...</div>
        </div>
        <div class="button-row">
          <button class="btn-secondary" id="clearLogsBtn">Clear Logs</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        $(tab.dataset.tab).classList.add('active');
      });
    });

    async function init() {
      const config = await window.bridge.getConfig();
      if (config) {
        $('serverUrl').value = config.serverUrl || '';
        $('authSecret').value = config.authSecret || '';
        $('tradingMode').value = config.tradingMode || 'paper';
        $('autoConnect').checked = config.autoConnect !== false;
      }

      const creds = await window.bridge.getCredentials();
      if (creds?.hasPaperKeys) {
        $('paperApiKey').placeholder = 'Configured (enter new to update)';
      }
      if (creds?.hasLiveKeys) {
        $('liveApiKey').placeholder = 'Configured (enter new to update)';
      }

      const status = await window.bridge.getConnectionStatus();
      updateConnectionUI(status);
    }

    function updateConnectionUI(status) {
      const dot = $('statusDot');
      const text = $('statusText');
      
      if (status.connected) {
        dot.className = 'status-dot connected';
        text.textContent = `Connected (${status.clientId})`;
        $('connectBtn').textContent = 'Disconnect';
        $('connectBtn').className = 'btn-danger';
      } else {
        dot.className = 'status-dot';
        text.textContent = status.error || 'Disconnected';
        $('connectBtn').textContent = 'Connect';
        $('connectBtn').className = 'btn-primary';
      }
    }

    function addLog(message, type = 'info') {
      const container = $('logContainer');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      container.insertBefore(entry, container.firstChild);
    }

    $('connectBtn').addEventListener('click', async () => {
      const status = await window.bridge.getConnectionStatus();
      if (status.connected) {
        await window.bridge.disconnect();
        updateConnectionUI({ connected: false });
        addLog('Disconnected', 'info');
      } else {
        $('statusDot').className = 'status-dot connecting';
        $('statusText').textContent = 'Connecting...';
        const result = await window.bridge.connect();
        if (!result.success) {
          updateConnectionUI({ connected: false, error: result.error });
          addLog(`Connection failed: ${result.error}`, 'error');
        }
      }
    });

    $('saveConfigBtn').addEventListener('click', async () => {
      const config = {
        serverUrl: $('serverUrl').value,
        authSecret: $('authSecret').value,
        tradingMode: $('tradingMode').value,
        autoConnect: $('autoConnect').checked,
      };
      await window.bridge.saveConfig(config);
      addLog('Configuration saved', 'success');
    });

    $('saveCredsBtn').addEventListener('click', async () => {
      const credentials = {
        paperApiKey: $('paperApiKey').value,
        paperSecretKey: $('paperSecretKey').value,
        liveApiKey: $('liveApiKey').value,
        liveSecretKey: $('liveSecretKey').value,
      };
      await window.bridge.saveCredentials(credentials);
      addLog('Credentials saved locally', 'success');
    });

    $('testAlpacaBtn').addEventListener('click', async () => {
      addLog('Testing Alpaca connection...', 'info');
      const result = await window.bridge.testAlpaca();
      if (result.success) {
        addLog(`Alpaca OK: Equity $${parseFloat(result.account.equity).toLocaleString()}`, 'success');
      } else {
        addLog(`Alpaca error: ${result.error}`, 'error');
      }
    });

    $('clearLogsBtn').addEventListener('click', () => {
      $('logContainer').innerHTML = '<div class="log-entry info">Logs cleared</div>';
    });

    window.bridge.onConnectionStatus((status) => {
      updateConnectionUI(status);
      if (status.connected) {
        addLog(`Connected to server`, 'success');
      } else if (status.error) {
        addLog(`Disconnected: ${status.error}`, 'error');
      }
    });

    window.bridge.onTradeSignal((signal) => {
      addLog(`Signal: ${signal.action} ${signal.quantity} ${signal.symbol}`, 'info');
    });

    window.bridge.onTradeResult((result) => {
      if (result.success) {
        addLog(`Order filled: ${result.signal.symbol} (${result.orderId})`, 'success');
      } else {
        addLog(`Order failed: ${result.error}`, 'error');
      }
    });

    window.bridge.onHeartbeat((timestamp) => {
      $('lastHeartbeat').textContent = `Last: ${new Date(timestamp).toLocaleTimeString()}`;
    });

    init();
  </script>
</body>
</html>
